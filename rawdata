import os
import json
import shutil
import pandas as pd
import cx_Oracle
import psycopg2
import pymysql
from openpyxl import load_workbook
from openpyxl.utils import get_column_letter

# === å›ºå®šåƒæ•¸è¨­å®š ===
task_list_path = r"C:\Users\***\***\***\***\***\list\lg_list.csv"
raw_template_path = r"C:\Users\***\***\***\***\***\raw\raw.xlsx"
summary_template_path = r"C:\Users\***\***\***\***\***\summary\summary.xlsx"
raw_output_folder = r"C:\Users\***\***\***\***\***\raw"
summary_output_folder = r"C:\Users\***\***\***\***\***\summary"
epi_output_folder = r"C:\Users\***\***\***\***\***\epi"

keep_cols = ['COL', 'ROW', 'VFLA03', 'IV3', 'WLD3', 'VFLA05', 'IV5', 'WLD5',
             'VFLA02', 'IV2', 'WLD2', 'VFLA04', 'IV4', 'WLD4', 'VF2', 'VF1', 'IR1', 'IR2']

# === 1. è®€å– PENDING ç‹€æ…‹çš„ wafer_id ===
df_task = pd.read_csv(task_list_path, dtype=str)
df_pending = df_task[df_task["status"].str.upper() == "PENDING"].copy()
wafer_ids = df_pending["waferid"].dropna().unique().tolist()
print(f"âœ… å–å¾—å¾…è™•ç† wafer_idï¼š{wafer_ids}")

# === 2. å¾ PostgreSQL æŸ¥å‡ºæœ€å¤§ serial çš„ EL filepathï¼ˆåŒ serial æ™‚é¸ id æœ€å¤§ï¼‰===
def get_el_filepath_by_waferid(wafer_id: str) -> str:
    conn = psycopg2.connect(
        host="***",
        port="***",
        database="***",
        user="***",
        password="***"
    )
    cursor = conn.cursor()
    cursor.execute("""
        SELECT filepath
        FROM public.probing_el_basic
        WHERE waferid = %s
          AND filepath IS NOT NULL
        ORDER BY serial DESC, id DESC
        LIMIT 1
    """, (wafer_id,))
    row = cursor.fetchone()
    cursor.close()
    conn.close()
    if not row:
        raise ValueError(f"âŒ PostgreSQL æŸ¥ç„¡ waferid = {wafer_id} å°æ‡‰æª”æ¡ˆ")
    path = row[0].replace("/", "\\")
    return path.encode("utf-8").decode("unicode_escape")

# === 2.1 ä¾ wafer_id å–å¾— EPI Rawdata æª”æ¡ˆè·¯å¾‘ï¼ˆæ²¿ç”¨ä½ æ¸¬è©¦æˆåŠŸçš„é‚è¼¯ï¼‰===
def get_epi_filepath_by_waferid(wafer_id: str) -> str:
    conn = psycopg2.connect(
        host="***",
        port="***",
        database="***",
        user="***",
        password="***"
    )
    cursor = conn.cursor()
    cursor.execute("""
        SELECT filepath
        FROM public.epi_basic
        WHERE waferid = %s
          AND (datatype IS NULL OR datatype = '')
        ORDER BY id DESC
        LIMIT 1
    """, (wafer_id,))
    row = cursor.fetchone()
    cursor.close()
    conn.close()

    if not row or not row[0]:
        raise ValueError(f"âŒ æŸ¥ç„¡ waferid={wafer_id} ä¸” datatype IS NULL çš„ filepath")

    raw_path = row[0]
    print("ğŸ“‚ DB åŸå§‹å€¼ï¼š", raw_path)

    # 1) é–‹é ­ // â†’ \\server
    if raw_path.startswith("//"):
        fixed = "\\\\" + raw_path.lstrip("/")
    else:
        fixed = raw_path

    # 2) å…¶é¤˜ / â†’ \
    fixed = fixed.replace("/", "\\")

    return fixed

# === 3. Oracleï¼šä»¥ WAFERNO æŸ¥ LASERMARK ===
def get_lasermark_by_waferno(wafer_id: str) -> str:
    dsn = cx_Oracle.makedsn("***", *** , service_name="***")
    conn = cx_Oracle.connect(user="***", password="***", dsn=dsn)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT LASERMARK
        FROM RPT.WAFER_BASIC_TABLE
        WHERE WAFERNO = :wafer_id
    """, {'wafer_id': wafer_id})
    row = cursor.fetchone()
    cursor.close()
    conn.close()
    if not row or row[0] is None:
        raise ValueError(f"âŒ Oracle æ‰¾ä¸åˆ° LASERMARKï¼ŒWAFERNO = {wafer_id}")
    return str(row[0]).strip()

# === Oracleï¼šä»¥ WAFERID+SHIPPING_ITEM å– VALUEï¼ˆå…±ç”¨ï¼‰ ===
def get_shipping_value(wafer_id: str, shipping_item: str):
    dsn = cx_Oracle.makedsn("***", *** , service_name="***")
    conn = cx_Oracle.connect(user="***", password="***", dsn=dsn)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT VALUE
        FROM RPT.EDC_SHIPPING_VALUE
        WHERE WAFERID = :wafer_id
          AND SHIPPING_ITEM = :shipping_item
          AND ROWNUM = 1
    """, {'wafer_id': wafer_id, 'shipping_item': shipping_item})
    row = cursor.fetchone()
    cursor.close()
    conn.close()
    if not row or row[0] is None:
        return None
    try:
        return float(row[0])
    except Exception:
        return str(row[0]).strip()

# === 4. è™•ç†æ¯å€‹ EL æª”æ¡ˆèˆ‡ summary æª”æ¡ˆ ===
processed_wafer_ids = []

for wafer_id in wafer_ids:
    try:
        # å–å¾— EL æª”æ¡ˆè·¯å¾‘ï¼ˆPG, å–æœ€å¤§ serialï¼‰
        el_path = get_el_filepath_by_waferid(wafer_id)
        print(f"âœ… {wafer_id} çš„ EL è·¯å¾‘ç‚ºï¼š{el_path}")

        # å–å¾— LASERMARKï¼ˆOracle, by WAFERNOï¼‰
        lasermark = get_lasermark_by_waferno(wafer_id)
        print(f"âœ… {wafer_id} çš„ LASERMARKï¼š{lasermark}")

        # è®€å–æª”æ¡ˆèˆ‡é¡è‰²
        with open(el_path, 'rb') as f:
            raw = f.read(10000)
        import chardet
        encoding = chardet.detect(raw)['encoding'] or 'utf-8'

        all_data = pd.read_csv(el_path, header=None, on_bad_lines='skip', dtype=str, engine='python', encoding=encoding)
        rgb_char = ''
        for i in range(len(all_data)):
            left_cell = str(all_data.iat[i, 0]).strip()
            if left_cell.upper() == 'LOTNUMBER':
                right_cell = str(all_data.iat[i, 1]).strip()
                if len(right_cell) >= 9:
                    rgb_char = right_cell[8].upper()
                break

        with open(el_path, 'r', encoding=encoding, errors='replace') as f:
            lines = f.readlines()
        header_row_idx = next((i for i, line in enumerate(lines) if 'COL' in line.upper() and 'ROW' in line.upper()), None)
        if header_row_idx is None:
            raise ValueError("âŒ æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—")

        df = pd.read_csv(el_path, skiprows=header_row_idx, header=0, encoding=encoding, on_bad_lines='skip')
        existing_cols = [col for col in keep_cols if col in df.columns]
        df = df[existing_cols].head(400)

        # === æ¬„ä½è½‰æ›ï¼ˆCOL = *** - åŸå€¼ï¼ŒROW = åŸå€¼ - ***ï¼‰===
        if 'COL' in df.columns:
            df['COL'] = *** - pd.to_numeric(df['COL'], errors='coerce')   # åŸ 1708
        if 'ROW' in df.columns:
            df['ROW'] = pd.to_numeric(df['ROW'], errors='coerce') - ***   # åŸ 481

        # === å„²å­˜ raw.xlsx ===
        raw_wb = load_workbook(raw_template_path)
        raw_ws = raw_wb.active
        raw_ws["B3"] = lasermark  # â† æ”¹æˆ LASERMARK
        # é¡è‰²å¯«å…¥æ–¼ E æ¬„ï¼›ä¾é¡è‰²æ±ºå®šéœ€è·³éä¸å¡«çš„æ¬„ä½
        skip_cols_by_color = set()
        if rgb_char in ("G", "B"):
            skip_cols_by_color = {"I", "J", "K", "O", "P", "Q"}
        elif rgb_char == "R":
            skip_cols_by_color = {"F", "G", "H", "L", "M", "N"}

        for i, row in df.iterrows():
            row_idx = 5 + i
            raw_ws[f"E{row_idx}"] = rgb_char
            for j, col in enumerate(existing_cols):
                # æ˜ å°„åˆ°æ¨¡æ¿ï¼šCã€Dï¼ŒEç‚ºé¡è‰²ï¼Œå¾ŒçºŒå¾ F èµ·ï¼ˆå› æ­¤ j>=2 è¦è·³é Eï¼‰
                col_offset = j if j < 2 else j + 1
                col_letter = get_column_letter(3 + col_offset)  # 3->C
                if col_letter in skip_cols_by_color:
                    continue
                raw_ws[f"{col_letter}{row_idx}"] = row[col]

        raw_path = os.path.join(raw_output_folder, f"{rgb_char}-{lasermark}.xlsx")  # â† æª”åæ”¹ç”¨ LASERMARK
        raw_wb.save(raw_path)

        # === 1) å¾ PG å–å¾— aoi_id / el_idï¼ˆåŸæœ‰é‚è¼¯ä¿ç•™ï¼‰===
        pg_conn = psycopg2.connect(host="***", port="***", database="***", user="***", password="***")
        pg_cursor = pg_conn.cursor()

        pg_cursor.execute("""
            SELECT id FROM public.aoi_basic
            WHERE waferid = %s AND opno = 'WN_CPOWIA-1'
            ORDER BY id DESC LIMIT 1
        """, (wafer_id,))
        row = pg_cursor.fetchone()
        aoi_id = row[0] if row else None

        pg_cursor.execute("""
            SELECT id FROM public.probing_el_basic
            WHERE waferid = %s AND opno = 'WN_CPOWIP-R'
            ORDER BY id DESC LIMIT 1
        """, (wafer_id,))
        row = pg_cursor.fetchone()
        el_id = row[0] if row else None

        pg_cursor.close()
        pg_conn.close()

        # === 2) AOI yield ===
        aoi_yield_ratio = None
        if aoi_id:
            mysql_conn = pymysql.connect(host="***", user="***", password="***", port=***, database="***")
            with mysql_conn.cursor() as cursor:
                cursor.execute("""
                    SELECT yield FROM aoi_data
                    WHERE basic_id = %s AND area = 'all' AND recipe LIKE %s
                    ORDER BY id DESC LIMIT 1
                """, (aoi_id, '%All'))
                row = cursor.fetchone()
                if row and row[0] is not None:
                    try:
                        y = float(row[0])
                        aoi_yield_ratio = y/100 if y > 1 else y  # ç™¾åˆ†æ¯”æˆ–æ¯”ä¾‹çš†å¯
                    except Exception:
                        aoi_yield_ratio = None
            mysql_conn.close()

        # === 3) EL JSON çµ±è¨ˆ ===
        el_data_avg = {}
        if el_id:
            mysql_conn = pymysql.connect(host="***", user="***", password="***", port=***, database="***")
            with mysql_conn.cursor() as cursor:
                cursor.execute("""
                    SELECT num_attribute FROM el_data
                    WHERE basic_id = %s AND area = 'all' AND recipe LIKE %s
                    ORDER BY id DESC LIMIT 1
                """, (el_id, '%All'))
                row = cursor.fetchone()
                if row and row[0]:
                    try:
                        data_json = json.loads(row[0])
                        el_data_avg = data_json.get("avg", {})
                    except json.JSONDecodeError:
                        print("âŒ JSON æ ¼å¼éŒ¯èª¤")
            mysql_conn.close()

        # === 4) 400 ç­†è¦æ ¼æª¢æŸ¥ï¼ˆç¬¦åˆæ¯”ä¾‹æ”¾åœ¨ ws["D3"]ï¼‰===
        df_check = df.copy()
        for col in ['VFLA03', 'WLD3', 'IR1', 'IR2']:
            if col in df_check.columns:
                df_check[col] = pd.to_numeric(df_check[col], errors='coerce')

        cond_vf  = df_check['VFLA03'].between(***, ***, inclusive='both') if 'VFLA03' in df_check else False  # åŸ 2.4~3.1
        cond_ir1 = (df_check['IR1'] < ***) if 'IR1' in df_check else False                                     # åŸ 0.1
        cond_ir2 = (df_check['IR2'] < ***) if 'IR2' in df_check else False                                     # åŸ 0.15

        if rgb_char == 'G':
            cond_wld = df_check['WLD3'].between(***, ***, inclusive='both') if 'WLD3' in df_check else False   # åŸ 524~534
        elif rgb_char == 'B':
            cond_wld = df_check['WLD3'].between(***, ***, inclusive='both') if 'WLD3' in df_check else False   # åŸ 457~465
        else:  # R or others: ç„¡ WLD3 æ¢ä»¶
            cond_wld = True

        # å°‡å–®ä¸€å¸ƒæ—è½‰æˆç­‰é•· Seriesï¼Œä¾¿æ–¼é€åˆ—é‹ç®—
        if isinstance(cond_vf, bool):
            cond_vf = pd.Series([cond_vf]*len(df_check), index=df_check.index)
        if isinstance(cond_ir1, bool):
            cond_ir1 = pd.Series([cond_ir1]*len(df_check), index=df_check.index)
        if isinstance(cond_ir2, bool):
            cond_ir2 = pd.Series([cond_ir2]*len(df_check), index=df_check.index)
        if isinstance(cond_wld, bool):
            cond_wld = pd.Series([cond_wld]*len(df_check), index=df_check.index)

        passed = (cond_vf & cond_ir1 & cond_ir2 & cond_wld).sum()
        conform_ratio = passed / 400  # ä»¥ 400 ç‚ºåˆ†æ¯ï¼ˆä¾éœ€æ±‚å›ºå®šï¼‰

        # === 5) å¾ Oracle å–å¾— Chip size-X / Chip size-Y ===
        chip_size_x = get_shipping_value(wafer_id, "Chip size-X")
        chip_size_y = get_shipping_value(wafer_id, "Chip size-Y")

        # === å„²å­˜ summary.xlsx ===
        summary_wb = load_workbook(summary_template_path)
        ws = summary_wb.active
        ws["A3"] = rgb_char
        ws["B3"] = lasermark  # â† æ”¹æˆ LASERMARK

        # P3/Q3ï¼šChip size-X / Chip size-Yï¼ˆOracleï¼‰
        if chip_size_x is not None:
            ws["P3"] = chip_size_x
        if chip_size_y is not None:
            ws["Q3"] = chip_size_y

        # C3ï¼šAOI yieldï¼ˆç™¾åˆ†æ¯”è¡¨ç¤ºï¼‰
        if aoi_yield_ratio is not None:
            ws["C3"] = aoi_yield_ratio
            ws["C3"].number_format = '0.00%'

        # D3ï¼š400ç­†ç¬¦åˆæ¯”ä¾‹ï¼ˆç™¾åˆ†æ¯”è¡¨ç¤ºï¼‰
        ws["D3"] = conform_ratio
        ws["D3"].number_format = '0.00%'

        # IR1/IR2
        ws["N3"] = el_data_avg.get("ir1")
        ws["O3"] = el_data_avg.get("ir2")

        # é¡è‰²å°æ‡‰æ¬„ä½
        if rgb_char == "R":
            ws["K3"] = el_data_avg.get("vfla05")
            ws["L3"] = el_data_avg.get("iv5")
            ws["M3"] = el_data_avg.get("wld5")
        elif rgb_char == "G":
            ws["H3"] = el_data_avg.get("vfla03")
            ws["I3"] = el_data_avg.get("iv3")
            ws["J3"] = el_data_avg.get("wld3")
        elif rgb_char == "B":
            ws["E3"] = el_data_avg.get("vfla03")
            ws["F3"] = el_data_avg.get("iv3")
            ws["G3"] = el_data_avg.get("wld3")

        # R3 / S3ï¼šChip Thickness / Total Thicknessï¼ˆç¶­æŒæ—¢æœ‰å¯«æ³•ï¼‰
        chip_thickness = get_shipping_value(wafer_id, "Chip Thickness")
        if chip_thickness is not None:
            ws["R3"] = chip_thickness
        total_thickness = get_shipping_value(wafer_id, "Total Thickness")
        if total_thickness is not None:
            ws["S3"] = total_thickness

        summary_path = os.path.join(summary_output_folder, f"{lasermark}.xlsx")  # â† æª”åæ”¹ç”¨ LASERMARK
        summary_wb.save(summary_path)

        # === 6) ä¾ wafer_id å–å¾— EPI Rawdata è·¯å¾‘ä¸¦è¤‡è£½åˆ°æœ¬æ©Ÿ ===
        epi_dest_path = None
        try:
            epi_src_path = get_epi_filepath_by_waferid(wafer_id)
            print(f"ğŸ” EPI åŸå§‹è·¯å¾‘ï¼š{epi_src_path}")
            if not os.path.exists(epi_src_path):
                print(f"âš ï¸ æ‰¾ä¸åˆ° EPI åŸå§‹æª”ï¼š{epi_src_path}ï¼ˆè«‹ç¢ºèªç¶²è·¯åˆ†äº«/æ¬Šé™/è·¯å¾‘ï¼‰")
            else:
                os.makedirs(epi_output_folder, exist_ok=True)
                ext = os.path.splitext(epi_src_path)[1]  # ä¾‹å¦‚ .dat / .csv / .txt
                epi_dest_path = os.path.join(epi_output_folder, f"{lasermark}-EPI{ext}")
                shutil.copyfile(epi_src_path, epi_dest_path)
                print(f"âœ… å·²è¤‡è£½ EPI Rawdata åˆ°ï¼š{epi_dest_path}")
        except Exception as epi_err:
            print(f"âš ï¸ è¤‡è£½ EPI Rawdata å¤±æ•—ï¼ˆwafer_id={wafer_id}ï¼‰ï¼š{epi_err}")

        # âœ… ä¸‰å€‹æª”æ¡ˆéƒ½å­˜åœ¨æ‰ç®—æˆåŠŸ
        if (os.path.exists(raw_path)
            and os.path.exists(summary_path)
            and epi_dest_path is not None
            and os.path.exists(epi_dest_path)):
            processed_wafer_ids.append(wafer_id)
            print(f"âœ… {wafer_id} å·²å®Œæˆ raw / summary / epi ä¸‰æª”æ¡ˆ")
        else:
            print(f"âš ï¸ {wafer_id} ç¼ºå°‘æª”æ¡ˆï¼Œæœªæ›´æ–°ç‚º DONE")

    except Exception as e:
        print(f"âŒ {wafer_id} è™•ç†å¤±æ•—ï¼š{e}")

# === 5. æ›´æ–° task_list.csv ç‹€æ…‹ ===
df_task.loc[df_task["waferid"].isin(processed_wafer_ids), "status"] = "DONE"
df_task.to_csv(task_list_path, index=False)
print(f"âœ… å·²æ›´æ–°ä¸‹åˆ— wafer ç‚º DONEï¼š{processed_wafer_ids}")
