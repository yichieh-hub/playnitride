import os
import shutil
import pandas as pd
from openpyxl import load_workbook
from openpyxl.utils import get_column_letter
from openpyxl.styles import PatternFill, Border, Side
from datetime import datetime

# === å›ºå®šåƒæ•¸è¨­å®š ===
input_ids = ["****", "****", "****", "****", "****", "****"]
summary_folder = r"C:\Users\***\***\***\***\summary"
report_template = r"C:\Users\***\***\***\***\***\report.xlsx"
output_folder = r"C:\Users\***\***\***\***\report"

# ä¾†æºè³‡æ–™å¤¾
epi_folder = r"C:\Users\***\***\***\***\epi"
raw_folder = r"C:\Users\***\***\***\***\raw"

# æ¡Œé¢æ ¹è·¯å¾‘ï¼ˆç›®çš„åœ°ï¼‰
desktop_root = r"C:\Users\***\Desktop"

# === æ—¥æœŸæ ¼å¼åŒ–ï¼ˆYYMMDDï¼‰===
today_str = datetime.today().strftime('%y%m%d')
output_filename = f"LGE_Shipping Report_{today_str}.xlsx"
report_output = os.path.join(output_folder, output_filename)

# === é¡è‰²è¨­å®š ===
fill_f_to_p = PatternFill(start_color="FFFAEADB", end_color="FFFAEADB", fill_type="solid")
fill_q_to_t = PatternFill(start_color="FFDEEDF2", end_color="FFDEEDF2", fill_type="solid")

# === é‚Šæ¡†æ¨£å¼è¨­å®š ===
thin_border = Border(
    left=Side(style='thin'),
    right=Side(style='thin'),
    top=Side(style='thin'),
    bottom=Side(style='thin')
)

# === è¼‰å…¥ Excel æ¨¡æ¿ ===
wb = load_workbook(report_template)
ws = wb.active  # ç¬¬ä¸€å¼µå·¥ä½œè¡¨

# === å¯«å…¥å¾ B6 é–‹å§‹ï¼Œæ¯å€‹ input_id ä¸€åˆ— ===
start_row = 6

for i, wafer_id in enumerate(input_ids):
    row = start_row + i
    summary_file = os.path.join(summary_folder, f"{wafer_id}.xlsx")

    if not os.path.exists(summary_file):
        print(f"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆ: {summary_file}")
        continue

    try:
        df = pd.read_excel(summary_file, header=None)
        third_row = df.iloc[2].tolist()

        for col_offset, value in enumerate(third_row):
            col_index = 2 + col_offset  # B æ¬„ç‚ºç¬¬ 2 æ¬„
            col_letter = get_column_letter(col_index)
            cell = ws[f"{col_letter}{row}"]
            cell.value = value
            cell.border = thin_border

            # âœ… D / E æ¬„ç™¾åˆ†æ¯”æ ¼å¼
            if col_letter in ["D", "E"] and isinstance(value, (int, float)):
                cell.number_format = '0.00%'

            # âœ… åŠ ä¸Šåº•è‰²ï¼ˆè¦–æ¬„ä½è€Œå®šï¼‰
            if 6 <= col_index <= 16:  # F ~ P
                cell.fill = fill_f_to_p
            elif 17 <= col_index <= 20:  # Q ~ T
                cell.fill = fill_q_to_t

    except Exception as e:
        print(f"âŒ è®€å–æˆ–å¯«å…¥éŒ¯èª¤ ({wafer_id}): {e}")

# === å„²å­˜çµæœ ===
os.makedirs(output_folder, exist_ok=True)
wb.save(report_output)
print(f"âœ… å·²å®Œæˆå ±è¡¨å¯«å…¥ï¼Œå„²å­˜ç‚ºï¼š{report_output}")

# === å»ºç«‹æ¡Œé¢è³‡æ–™å¤¾ï¼ˆåç¨± = å ±è¡¨æª”åï¼ŒåŒ…å« .xlsxï¼‰===
dest_folder = os.path.join(desktop_root, output_filename)
os.makedirs(dest_folder, exist_ok=True)

# === è¤‡è£½å ±è¡¨æª”æ¡ˆåˆ°è³‡æ–™å¤¾ ===
shutil.copy2(report_output, os.path.join(dest_folder, output_filename))

# === è¤‡è£½æª”æ¡ˆçš„é€šç”¨å‡½å¼ ===
def copy_from_folder(folder_path: str, input_ids: list, dest: str, label: str, match_mode: str):
    if not os.path.isdir(folder_path):
        print(f"âš ï¸ {label} ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼š{folder_path}")
        return 0
    copied = 0
    files = [f for f in os.listdir(folder_path) if os.path.isfile(os.path.join(folder_path, f))]
    for wafer_id in input_ids:
        if match_mode == "prefix":
            matched = [f for f in files if f.startswith(wafer_id)]
        else:  # suffix
            matched = []
            for f in files:
                name_wo_ext, _ = os.path.splitext(f)
                if name_wo_ext.endswith(wafer_id):
                    matched.append(f)
        for fname in matched:
            src = os.path.join(folder_path, fname)
            dst = os.path.join(dest, fname)
            shutil.copy2(src, dst)
            copied += 1
            print(f"ğŸ“ {label} å·²è¤‡è£½ï¼š{fname}")
    return copied

# === è¤‡è£½ EPI (å‰ç¶´ç¬¦åˆ input_id) ===
epi_copied = copy_from_folder(epi_folder, input_ids, dest_folder, "EPI", "prefix")

# === è¤‡è£½ RAW (çµå°¾ç¬¦åˆ input_id) ===
raw_copied = copy_from_folder(raw_folder, input_ids, dest_folder, "RAW", "suffix")

print(f"âœ… è¤‡è£½ç¸½çµï¼šEPI {epi_copied} å€‹ã€RAW {raw_copied} å€‹")

# === æœ€å¾Œï¼šæŠŠæ¡Œé¢è³‡æ–™å¤¾å£“ç¸®æˆ ZIP ===
zip_path = shutil.make_archive(dest_folder, 'zip', root_dir=desktop_root, base_dir=output_filename)
print(f"âœ… å·²å°‡è³‡æ–™å¤¾å£“ç¸®ç‚º ZIPï¼š{zip_path}")
